<%-include('../layouts/header.ejs') -%>
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cart</title>
    <link rel="apple-touch-icon" sizes="180x180" href="" />
    <!-- assets/img/favicons/apple-touch-icon.png -->
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="assets/img/favicons/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="assets/img/favicons/favicon-16x16.png"
    />
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="assets/img/favicons/favicon.ico"
    />
    <link rel="manifest" href="assets/img/favicons/manifest.json" />
    <meta
      name="msapplication-TileImage"
      content="assets/img/favicons/mstile-150x150.png"
    />
    <meta name="theme-color" content="#ffffff" />

    <!-- ===============================================-->
    <!--    Stylesheets-->
    <!-- ===============================================-->
    <link href="assets/css/theme.css" rel="stylesheet" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
      body {
        background-color: #fbfbfb;
      }
      @media (min-width: 991.98px) {
        main {
          padding-left: 240px;
        }
      }
      .quantity {
        width: 43px;
      }
      .add {
        width: 28px;
        border: white;
        border-radius: 24px;
      }
      .subract {
        width: 28px;
        border: white;
        border-radius: 24px;
      }
      /* Sidebar */
      .sidebar {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        padding: 58px 0 0; /* Height of navbar */
        box-shadow: 0 2px 5px 0 rgb(0 0 0 / 5%), 0 2px 10px 0 rgb(0 0 0 / 5%);
        width: 240px;
        z-index: 600;
      }
      .contentbox {
        margin-left: 25%;
      }

      @media (max-width: 991.98px) {
        .sidebar {
          width: 100%;
        }
      }
      .sidebar .active {
        border-radius: 5px;
        box-shadow: 0 2px 5px 0 rgb(0 0 0 / 16%), 0 2px 10px 0 rgb(0 0 0 / 12%);
      }

      .sidebar-sticky {
        position: relative;
        top: 0;
        height: calc(100vh - 48px);
        padding-top: 0.5rem;
        overflow-x: hidden;
        overflow-y: auto; /* Scrollable contents if viewport is shorter than content. */
      }
    </style>
  </head>
  <body>
    <!--Main Navigation-->
    <header>
      <!-- Sidebar -->
      <nav
        id="sidebarMenu"
        class="collapse d-lg-block sidebar collapse bg-white"
      >
        <div class="position-sticky">
          <div class="list-group list-group-flush mx-3 mt-4">
            <a
              href="/view-profile"
              class="list-group-item list-group-item-action py-2 ripple"
              aria-current="true"
            >
              <i class="fas fa-tachometer-alt fa-fw me-3"></i
              ><span>My Profile</span>
            </a>
            <a
              href="/view-orders"
              class="list-group-item list-group-item-action py-2 ripple"
            >
              <i class="fas fa-chart-area fa-fw me-3"></i><span>My Orders</span>
            </a>
            <a
              href="/view-wishlist"
              class="list-group-item list-group-item-action py-2 ripple"
            >
              <i class="fas fa-chart-area fa-fw me-3"></i
              ><span>My Wishlist</span>
            </a>
            <a
              href="/view-cart"
              class="list-group-item list-group-item-action py-2 ripple active"
            >
              <i class="fas fa-chart-area fa-fw me-3"></i><span>My Cart</span>
            </a>
          </div>
        </div>
      </nav>
      <!-- Sidebar -->

      <!-- Navbar -->
    </header>
    <!--Main Navigation-->

    <!--Main layout-->
    <main style="margin-top: 58px">
      <div class="container pt-4"></div>
    </main>
    <!--Main layout-->

    <nav
      class="navbar navbar-expand-lg navbar-light fixed-top py-3 d-block"
      data-navbar-on-scroll="data-navbar-on-scroll"
    >
      <div class="container">
        <a class="navbar-brand d-inline-flex" href="/"
          ><img
            class="d-inline-block"
            src="assets/img/gallery/logo.png"
            alt="logo"
          /><span class="text-1000 fs-0 fw-bold ms-2">Majestic</span></a
        >
        <button
          class="navbar-toggler collapsed"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div
          class="collapse navbar-collapse border-top border-lg-0 mt-4 mt-lg-0"
          id="navbarSupportedContent"
        >
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item px-2">
              <a
                class="nav-link fw-medium active"
                aria-current="page"
                href="/view-Women"
                >Women</a
              >
            </li>
            <% cate.forEach(function(cate){%>
            <li class="nav-item px-2">
              <a
                class="nav-link fw-medium active"
                aria-current="page"
                href="/view-<%= cate.name %>"
                ><%= cate.name%></a
              >
            </li>
            <%})%>
            <li class="nav-item px-2">
              <a class="nav-link fw-medium" href="/viewProducts">All Items</a>
            </li>
          </ul>
          <form class="d-flex">
            <a class="text-1000" href="/view-orders">
              <svg
                class="feather feather-phone me-3"
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
                ></path></svg
            ></a>

            <a class="text-1000" href="/view-cart">
              <svg
                class="feather feather-shopping-cart me-3"
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="9" cy="21" r="1"></circle>
                <circle cx="20" cy="21" r="1"></circle>
                <path
                  d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"
                ></path></svg
            ></a>

            <a class="text-1000" href="/view-profile">
              <svg
                class="feather feather-user me-3"
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle></svg
            ></a>

            <a class="text-1000" href="/view-wishlist">
              <svg
                class="feather feather-heart me-3"
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"
                ></path></svg
            ></a>

            <a href="/logout">Log Out</a>
          </form>
        </div>
      </div>
    </nav>

    <div class="container contentbox pt-6 pe-5">
      <form action="" id="checkout-form">
        <div class="row">
          <div class="col-md-6">
            <% if(addresses.length==0){%>
              <br>
              <br><br>
              <h4 style="color: cadetblue;">Please add address!!</h4>
              <%}%>
            <% for(let i = 0; i < addresses.length; i++) { %>

            <input
              type="radio"
              name="address"
              id="address"
              value="<%= addresses[i].address.name %>,<%= addresses[i].address.district %>,<%= addresses[i].address.state %>,<%= addresses[i].address.pin %>,<%= addresses[i].address.phone %>"
              required
            />
            <label for="address">
              <%= addresses[i].address.name %> ,<%=
              addresses[i].address.district %>,
              <br /><%= addresses[i].address.state %>, <%=
              addresses[i].address.pin %>, <%= addresses[i].address.phone %>
            </label>

            <div class="">
              <a
                href="/delete-address?id=<%=addresses[i].address._id  %>"
                class="btn btn-danger btn-sm"
                >Delete</a
              >
            </div>

            <br />
            <br />
            <%}%>
            <div class="container mt-2 ms-1" >
       <a href="/add-address?id=<%= userid %>" class="btn btn-primary"
          >Add Address</a
        >
    </div>
       
          </div>
          
          <div class="col-md-4">
            <div class="container mt-5 ml-5 checkout">
              <div class="payment">
                <div
                  class="col p-3"
                  style="
                    border-width: 1px;
                    border-color: black;
                    border-style: solid;
                  "
                >
                  <h5>Total Amount:</h5>
                  <h5 id="gt2"><%= Total %></h5>
                  <hr />
                  <p>Payment Method</p>
                  <form action="" >
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        name="paymod"
                        id="cod"
                        value="COD"
                      />
                      <label class="form-check-label" for="flexRadioDefault1">
                        COD
                      </label>
                    </div>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        name="paymod"
                        id="online-payment"
                        value="ONLINE"
                        checked
                      />
                      <label class="form-check-label" for="flexRadioDefault2">
                        Online Payment
                      </label>
                    </div>
                    <% if(addresses.length==0){ %>
                    <button class="btn btn-primary float-right" type="submit" disabled>
                      Checkout
                    </button>
                  <%}else{%>
                    <button class="btn btn-primary float-right" type="submit">
                      Checkout
                    </button>
                    <%}%>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>

        <script>
          $("#checkout-form").submit((e) => {
            const amount = document.getElementById("gt2").innerHTML;
            let address = $('input[name=address]:checked').val()
            let paymod = $('input[name=paymod]:checked').val()

            console.log(amount, address + paymod);
            e.preventDefault();
            $.ajax({
              url: "/place-order",
              method: "post",
              data:{
                amount:amount,
                address:address,
                paymod:paymod
              },

              success: (response) => {
                if (response.codSuccess == true) {
                  location.href = "/order-placed";
                } else {
                  razorpayPayment(response.order);
                }
              },
            });
          });

          function razorpayPayment(order) {
            var options = {
              key: "rzp_test_uMmtCx7BlPzTfd",
              amount: order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
              currency: "INR",
              name: "ddellonsy Corp",
              description: "Test Transaction",
              image: "https://example.com/your_logo",
              order_id: order.id,
              handler: function (response) {
                verifyPayment(response, order);
              },
              prefill: {
                name: "Gaurav Kumar",
                email: "gaurav.kumar@example.com",
                contact: "9000090000",
              },
              notes: {
                address: "Razorpay Corporate Office",
              },
              theme: {
                color: "#3399cc",
              },
            };
            var rzp1 = new Razorpay(options);
            rzp1.open();
          }

          function verifyPayment(payment, order) {
            console.log(payment);
            $.ajax({
              url: "/verify-payment",
              method: "post",
              data: {
                payment,
                order,
              },              
              success: (response) => {
                if (response.success) {
                  location.href = "/order-placed";
                } else {
                  alert("payment failed");
                }
              },
            });
            console.log(order)
          }
        </script>

        <!-- <script src="vendors/@popperjs/popper.min.js"></script>
    <script src="vendors/bootstrap/bootstrap.min.js"></script>
    <script src="vendors/is/is.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=window.scroll"></script>
    <script src="vendors/feather-icons/feather.min.js"></script>
    <script>
      feather.replace();
    </script>
    <script src="assets/js/theme.js"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Jost:wght@200;300;400;500;600;700;800;900&amp;display=swap"
      rel="stylesheet"
    /> -->
    
        <br />
        <br />
        <!-- ---------------------------------------------------------- -->

        <%-include('../layouts/footer.ejs') -%>
      </form>
      <div class="col-md-4">
        <div class="container mt-5 ml-5 checkout">
          <div class="payment">
            <div
              class="col p-3"
              style="
                border-width: 1px;
                border-color: black;
                border-style: solid;
              "
            >
              <h6>Total Amount:<%= Total %></h6>
              <hr />
              <h5>Discounted Amount:</h5>
              <h6 id="gt"><%= Total %></h6>
              <hr />
              <form action="" method="POST" id="couponForm" onsubmit="return validate()">
                <label for="">Coupon CODE</label>
                <br />
                <input type="text" name="code" id="code" />
                <label for="" id="invalid"style="color: rgb(209, 32, 32); visibility: hidden">Invalid Coupon</label>
                <input hidden value="<%= Total %>" id="total" />
                
                <br />
                <br />
                <button class="btn btn-primary float-right" type="submit">
                  Apply
                </button>

              </form>
              <script>
                function validate(){
                  let code=document.getElementById('code')

                  if(code.value.trim()===''){
                    document.getElementById("invalid").style.visibility = "visible";
                     return false;

                  }else{
                    document.getElementById("invalid").style.visibility = "hidden";

                  }
                }
              </script>
            </div>
          </div>
        </div>
      </div>

      <script>
        $("#couponForm").submit((e) => {
          e.preventDefault();
          let code = document.getElementById("code").value;
          let total = document.getElementById("total").value;

          $.ajax({
            url: "/apply-coupon",
            method: "post",
            encoded: true,
            data: {
              code: code,
              total: total,
            },
          }).done((data) => {
            if (data.success) {
              document.getElementById("gt").innerHTML = data.grandTotal;
              document.getElementById("gt2").innerHTML = data.grandTotal;
            }else{
              document.getElementById("invalid").style.visibility = "visible";

            }
          });
        });
      </script>
    </div>
  </body>
</html>
